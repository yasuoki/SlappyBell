# SlappyBell firmware
## About
SlappyBell Firmwareは、デスクトップ用の通知ガジェットSlappyBell用のファームウェアです。  
ESP32-S3を使用したArduinoプログラムで、6個のフィギュアに配置したネオピクセルLEDを好きな色で発光させ、通知音を内蔵スピーカーから鳴らすことができます。

主な用途は、見落としがちなSlackのメッセージを通知することです。
デスクトップPC用のアプリSlappyHubと連動して動作し、Slackのメッセージをフィルタリングして本当に必要なメッセージにだけ反応し、チャンネル毎に割り当てられたフィギュアを発光させます。  
[SlappyHubリポジトリ](https://github.com/yasuoki/SlappyHub)

Slackとの連携は、デスクトップアプリSlappyHub側の動作で、SlappyBell自体はUSBシリアル経由でPC側アプリから送られたコマンドによって、LEDとサウンドをコントロールする単純な機能だけを持っています。  
つまり、PC側アプリの動作次第で、Slackだけではなくメールや他のメッセジャー、またタイマーなど通知を必要とする様々な場面で使用することができます。

## Features
- LEDの色や発光パターンの制御
- 内蔵ストレージ内のmp3ファイルの再生
- URLで指定するネットワーク上のmp3ファイルの再生
- mp3ファイルの内蔵ストレージへの保存

## Commands
### Wi-Fiネットワークへの接続
```
wifi [<ssid> <password>]
```

- `<ssid>`  
Wi-FiのSSID（ネットワーク名）

- `<password>`  
Wi-Fiのパスワード

指定のアクセスポイントへ接続します。  
ネットワーク接続は、ネット上のmp3ファイルの再生を行う場合に限り必要となります。  
`<ssid>`と`<password>`を指定しない場合、現在のWiFiステータスを返します。

### LEDの点灯
```
led-on <led> <pattern>
```  

- `<led>`  
0から5の整数を指定してください。0は左のLED、5は右側LEDに対応します。  
- `<pattern>`  
下記の書式で発光パターンを指定します。

6個のLEDは、個別に発光パターンを指定して点灯させることができ、`led-off`コマンドで消灯させるまで指定パターンを繰り返して点灯します。  
既に点灯中のLEDに対し、`led-on`コマンドを実行した場合、即座に新しいコマンドのパターンに変更されます。

#### 発光パターンの指定
`RRGGBB`  
16進数6桁で色を指定します。  

色は、`,` (カンマ)または`>`で接続して複数指定することもできます。

`RGB1,RGB2,RGB3`  
最初にRGB1の色で発光し、次にRGB2で発光、RGB3の後は再びRGB1で発光とループし、1秒ごとに色を切り替えます。  

`RGB1:100,RGB2:100,RGB3:100`  
ミリ秒単位で時間を指定して色を切り替えます。  
この例の場合、100ミリ秒ごとに色が切り替わります。

`RGB1>RGB2>RGB3>`  
色を滑らかに変化させながらループ発光します。  
RGB1が`ff0000`でRGB2が`00ff00`の場合、0.1秒後には`e61900`となり、0.5秒後には`7f7f00`に、1秒後には`00ff00`と変化します。

`RGB1:2000>RGB2:2000>RGB3:2000>`  
ミリ秒単位の時間を指定して色を変化させます。

### LEDの消灯
```
led-off <led>
```

- `<led>`  
0から5の整数を指定してください。0は左のLED、5は右側LEDに対応します。指定位置のLEDが点灯している場合消灯します。

### mp3ファイルの再生
```
play <mp3_file>
```

- `<mp3_file>`  
`http://`で始まる場合、URLとして扱い指定した場所のmp3ファイルをダウンロード再生します。  
それ以外は、内蔵ストレージのファイル名として扱い、指定のファイルを再生します。

指定したmp3ファイルを再生します。  
既に別の音声を再生中の場合、即座に停止して新しい音声を再生します。
再生可能なmp3ファイルは、サンプリング周波数44.1kHz、モノラルまたはステレオ、ビットレート96~192kbps(CBR)です。  
高ビットレートになるほど、再生時間が長くなるほどESP32-S3の負荷が高くなり不安定になりやすいので、通知音にふさわしい低ビットレートで短いファイルを使用するようにしてください。  
特にネット上のファイルの再生は通信環境の影響もあり不安定になりやすいので、できるだけ内蔵ストレージを使用してください。
  

### mp3ファイル再制停止
```
stop
``` 

再生中のmp3を停止します。

### mp3ファイルのアップロード
```
upload <mp3_file> <size>
<data>
```  

- `<mp3_file>`  
ファイル名を指定します。  
ファイル名に使用できる文字は、英数字とスペース及び'/'を除く記号dえ、大文字小文字は区別されます。  
- `<size>`  
ファイルのサイズを10進数のバイト数で指定します。
- `<data>`  
mp3ファイルのバイナリデータで送信します。

### mp3ファイルの削除
```
remove <mp3_file>
```  

- `<mp3_file>`  
削除したいファイル名を指定します。

指定したファイルを内蔵ストレージから削除します。  

### mp3ファイルの一覧
```aiignore
list
```

内蔵ストレージに保存されているmp3ファイルをリストします。
また、ストレージの全容量と使用中の容量を表示します。
```
[R@APM] 00 OK+
Storage Usage: <usage>/<capacity>
Files:
sound1.mp3 <size>
sound2.mp3 <size>
sound3.mp3 <size>

```
応答の`<usage>`は現在のストレージ使用量、`<capacity>`はストレージの全容量、`<size>`は個々のファイルのサイズを示します。


### バージョン情報
```aiignore
\n
```

空行の入力で、以下の形式でバージョン情報を表示します。

```aiignore
Yonabe Factory / SlappyBell / VERSION 1.0.0
```
